name: Deploy

on:
  push:
    branches:
      - master

env:
  NOTIFY_MATRIX: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üõé Checkout
        id: checkout
        uses: actions/checkout@v3

      - uses: ./.github/workflows/rust-install

      - name: ‚öô Run verifier
        id: verify
        run: make verifier

      - name: Send error to Matrix channel
        uses: s3krit/matrix-message-action@v0.0.3
        if: failure() && steps.verify.outcome == 'failure'
        with:
          room_id: ${{ secrets.MATRIX_ROOM_ID }}
          access_token: ${{ secrets.MATRIX_ACCESS_TOKEN }}
          server: ${{ secrets.MATRIX_SERVER }}
          message: "Error updating metadata! ‚ùå
                          ${{ github.verify.outcome }}"

      - name: ‚öô Run collector
        id: collect
        run: make collector

      - name: Send error to Matrix channel
        uses: s3krit/matrix-message-action@v0.0.3
        if: failure() && steps.collect.outcome == 'failure'
        with:
          room_id: ${{ secrets.MATRIX_ROOM_ID }}
          access_token: ${{ secrets.MATRIX_ACCESS_TOKEN }}
          server: ${{ secrets.MATRIX_SERVER }}
          message: "Error updating metadata! ‚ùå
                              ${{ github.collect.verify }}"

      - uses: ./.github/workflows/deploy
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
